{"componentChunkName":"component---src-templates-blog-js","path":"/blog/nodejs-event-loop","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Node.js Event Loop","date":"2020-10-10"},"html":"<p>สวัสดีครับ ไม่ได้เขียน blog มานานเป็นเดือนละ เนื่องจากผมค่อนข้างยุ่งกับการเปลี่ยนงานใหม่และงานก็ค่อนข้างถาโถมเข้ามาแบบเยอะเลยทีเดียว (555) แต่ก็ยังพอมีเวลาไปศึกษา <code>node.js</code> เพิ่มเติมอยู่บ้าง โดยเฉพาะการทำงานภายในของตัว <code>node.js</code> เอง ซึ่ง blog นี้ก็จะนำเสนอเกี่ยวกับ <strong>Event Loop</strong> ซึ่งมีบทบาทสำคัญเป็นอย่างมากในตัว <code>node.js</code> core หวังว่าจะเป็นประโยชน์ต่อคนที่กำลังศึกษา <code>node.js</code> อยู่นะครับ code และเนื้อหาหลักๆ ผมจะอ้างอิงจาก <a href=\"https://www.udemy.com/course/advanced-node-for-developers/\">Node JS: Advanced Concepts</a> ของ <a href=\"https://twitter.com/ste_grider\">Stephen Grider</a> ครับผม</p>\n<h2>Prerequisite</h2>\n<ul>\n<li>Intermediate Javascript (asynchronous, callbacks)</li>\n</ul>\n<h2>What is the Event Loop?</h2>\n<p>Node.js คือ runtime environment เพื่อดำเนินการ run Javascript ฝั่ง server side เราทราบกันดีอยู่แล้วว่า Javascript ทำงานบน <strong>Single-Threaded</strong> ดังนั้น Event Loop คือสิ่งที่คอยจัดการ <strong>asynchronous non-blocking I/O operations</strong> ใน node นั่นเอง เปรียบเสมือนเป็นโครงสร้างที่ควบคุมและตัดสินใจว่าจะทำ task ใดในช่วงเวลาหนึ่งบน thread นั้นๆ ซึ่งการทำงานของ Event Loop จะทำงานอยู่บน thread เดียวโดยมีวัฏจักรการทำงานตาม diagram รูปล่าง</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">   ┌───────────────────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">┌─</span><span class=\"mtk8\">&gt;</span><span class=\"mtk1\">│           timers          │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  └─────────────┬─────────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  ┌─────────────┴─────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  │     pending callbacks     │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  └─────────────┬─────────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  ┌─────────────┴─────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  │       idle, prepare       │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  └─────────────┬─────────────┘      ┌───────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  ┌─────────────┴─────────────┐      │   incoming:   │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  │           poll            │</span><span class=\"mtk8\">&lt;</span><span class=\"mtk1\">─────┤  connections, │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  └─────────────┬─────────────┘      │   data, etc.  │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  ┌─────────────┴─────────────┐      └───────────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  │           check           │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  └─────────────┬─────────────┘</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">│  ┌─────────────┴─────────────┐</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">└──┤      close callbacks      │</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   └───────────────────────────┘</span></span></code></pre>\n<p><em>Ref: <a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/\">The Node.js Event Loop, Timers, and <code>process.nextTick()</code></a></em></p>\n<p>สมมติว่าเราเขียน code ในไฟล์ <code>index.js</code> แล้วเราจะใช้คำสั่ง run <code>node index.js</code> แต่ละช่วง Event Loop จะมีการทำงานดังต่อไปนี้</p>\n<ul>\n<li><strong>Timers</strong>: เป็นการจัดการเกี่ยวกับเวลา เช่น <code>setTimeout()</code> หรือ <code>setInterval()</code></li>\n<li><strong>Pending callbacks</strong>: เป็นช่วงที่ต้องจัดการเกี่ยวกับ callbacks ต่างๆ</li>\n<li><strong>Idle, prepare</strong>: เป็นช่วงเวลาที่ event loop กลับไปอยู่ที่สถานะ \"รอ\" เพื่อให้ tasks ใดๆ ดำเนินการเสร็จ เดี๋ยวผมจะลงรายละเอียดอีกทีนะครับ</li>\n<li><strong>Poll</strong>: จัดการเกี่ยวกับ I/O event ต่างๆ</li>\n<li><strong>Check</strong>: <code>setImmediate()</code> callbacks</li>\n<li><strong>Close callbacks</strong>: close event ต่างๆ เช่น <code>socket.on('close', ...)</code></li>\n</ul>\n<p>ทีนี้อาจจะยังมองภาพไม่ออกว่าแต่ละช่วงนั้น Event Loop มันทำงานของมันยังไงกันแน่ ต่อไปผมจะเอาแต่ละช่วงมาเขียนเป็น psuedo code ดูนะครับ เพื่อให้เข้าใจมากขึ้น</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"javascript\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk3 mtki\">//----- Totally FAKE code -----//</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// สมมติว่า run node index.js</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// Tasks ต่างๆ ที่ Event Loop ต้องทำการตรวจสอบ</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// และตัดสินใจว่าจะดำเนินการอย่างไรต่อไป</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">pendingTimers</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [];</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">pendingOSTasks</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [];</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">pendingOperations</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [];</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// shouldContinue() คือตัวแทนการทำงานของ Event Loop</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// ซึ่ง function นี้จะคืนค่า truthy หรือ falsy</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">function</span><span class=\"mtk1\"> </span><span class=\"mtk7\">shouldContinue</span><span class=\"mtk1\">() {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">return</span><span class=\"mtk1\"> (</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk7\">pendingTimers</span><span class=\"mtk1\">.length </span><span class=\"mtk8\">||</span><span class=\"mtk1\"> </span><span class=\"mtk7\">pendingOSTasks</span><span class=\"mtk1\">.length </span><span class=\"mtk8\">||</span><span class=\"mtk1\"> </span><span class=\"mtk7\">pendingOperations</span><span class=\"mtk1\">.length</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  );</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">}</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// เข้าสู่ Event Loop</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk8\">while</span><span class=\"mtk1\"> (</span><span class=\"mtk7\">shouldContinue</span><span class=\"mtk1\">()) {}</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// exit back to terminal</span></span></code></pre>\n<h2>Event Loop's phases in Detail</h2>\n<p>รายละเอียดการทำงานในแต่ละช่วงของ Event Loop มีดังนี้</p>\n<ol>\n<li><strong>Event Loop</strong> จะตรวจสอบว่ามี task ใน <code>pendingTimers</code> หรือไม่ ซึ่งก็คือ <code>setTimeout()</code> และ <code>setInterval()</code> ถ้ามี ก็จะทำการ execute callbacks function ที่อยู่ใน <code>pendingTimers</code> เหล่านั้น</li>\n<li>ต่อไปก็คือการตรวจสอบว่ามี <code>pendingOSTasks</code> และ <code>pendingOperations</code> อยู่หรือไม่ เช่น การเรียก <code>httpServer.listen(PORT)</code> หรือการเรียกใช้ file system module <code>fs</code></li>\n<li>\n<p>จากนั้น Event Loop จะเข้าสู่ <strong>idle, prepare</strong> รอที่จะดำเนินการต่อไปเมื่อ</p>\n<ul>\n<li>ทำ <code>pendingOSTasks</code> เสร็จ</li>\n<li>ทำ <code>pendingOperations</code> เสร็จ</li>\n<li>timer ถึงเวลาที่กำหนดและดำเนินการเรียก callback function ในนั้น</li>\n</ul>\n</li>\n<li>ตรวจสอบ <code>pendingTimers</code> อีกครั้งและเรียก <code>setImmediate</code> function</li>\n<li>จัดการ <code>close event</code> เช่น <code>socket.on('close', ...)</code> หรือ <code>readStream.on('close', ...)</code></li>\n</ol>\n<p>ถ้ามี <code>pendingTask</code> ใดใดสักอันหนึ่งที่มี task อยู่ข้างใน (length > 0) <code>shouldContinue()</code> ก็จะคืนค่าเป็น <code>true</code> Event Loop ก็จะดำเนินวัฏจักรของมันไปเรื่อยๆ (<code>while (true) {}</code>) จนกว่าทุก ๆ <code>pendingTask</code> หมดไป <code>shouldContinue()</code> ก็จะคืนค่าเป็น <code>false</code> และออกมาจาก loop นั่นเอง</p>\n<h2>Is Node.js single-threaded?</h2>\n<p>มาถึงตรงนี้ อยากจะตั้งคำถามกับคุณผู้อ่านสักหน่อยว่า Node.js เป็น single-thread หรือไม่?</p>\n<p>คำตอบคือ...</p>\n<p><strong><em>ทั้งใช่ และไม่ใช่...</em></strong></p>\n<p>เริ่มงงกันแล้วใช่มั้ยครับ 555</p>\n<p>ผมจะแบ่งเป็น 2 ประเด็นหลักๆ ละกันนะครับ</p>\n<ol>\n<li>ถ้าเป็นตัว Event Loop - ใช่ครับ มันทำงานอยู่บน single-threaded</li>\n<li>แต่ถ้าเป็น module หรือ standard library บางตัวของ เช่น <code>fs, crypto, zlib</code> - ไม่ใช่ single-threaded ครับ</li>\n</ol>\n<p>บางคนอาจจะสงสัย ว่าอ้าว javascript เป็น single-threaded นี่ node เองก็ใช้ javascript แล้วทำไมไม่ใช่ single-thread ทั้งหมดล่ะ</p>\n<p>ลองมาดูตัวอย่างกันครับ</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"javascript\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// thread.js</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\"> } </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;crypto&#39;</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;pwd&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;salt&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">100000</span><span class=\"mtk1\">, </span><span class=\"mtk6\">512</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;sha512&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">console</span><span class=\"mtk1\">.</span><span class=\"mtk7\">log</span><span class=\"mtk1\">(</span><span class=\"mtk11\">`1: Done in ${</span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk11\">}ms`</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">);</span></span></code></pre>\n<p><code>pdkdf2</code> เป็น function ที่ใช้ทำการเข้ารหัส ในตัวอย่างจะใช้ <code>sha512</code> เป็น secure hash algorithm ทีนี้ลอง run <code>node thread.js</code> ดูครับ ก็จะได้ผลลัพธ์ประมาณนี้</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.702127659574465%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA5klEQVQoz52OzU6DUBCFb//gloughYtF/lqoFUFwYRNXJr6CK+PKl/ABfPNPbGhCojamiy9zMjPnzIjnj0+2dcVDlXFbROzanLZccXedUG1C8vCKINV4mYdnK+qioL3ZUl+mPK0aHpOS+3BN7C5YKAuxe30nzVKaTUQanFOul1R5Qh75aMfgwpRINWVmT7DGY0whMHrMAYeeaF7ecFyHZWcOXEnkW+izTjsmsVb4ykZ1fekaOIbBvDMdQ4TWnMngwnSgZ32V/bI50L/xPROx1nujNRodvSz/0D8+jH1/H3hqwL8DT+UL+rqeLe5+jWsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hash\"\n        title=\"hash\"\n        src=\"/static/e0c5b766eea639660b8bf06ff4e25daf/1d69c/first_threaded.png\"\n        srcset=\"/static/e0c5b766eea639660b8bf06ff4e25daf/4dcb9/first_threaded.png 188w,\n/static/e0c5b766eea639660b8bf06ff4e25daf/5ff7e/first_threaded.png 375w,\n/static/e0c5b766eea639660b8bf06ff4e25daf/1d69c/first_threaded.png 750w,\n/static/e0c5b766eea639660b8bf06ff4e25daf/26a94/first_threaded.png 1102w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>ทีนี้ลองเพิ่มไปอีก 3 ชุดคำสั่ง</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"javascript\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\"> } </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;crypto&#39;</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;pwd&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;salt&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">100000</span><span class=\"mtk1\">, </span><span class=\"mtk6\">512</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;sha512&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">console</span><span class=\"mtk1\">.</span><span class=\"mtk7\">log</span><span class=\"mtk1\">(</span><span class=\"mtk11\">`1: Done in ${</span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk11\">}ms`</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;pwd&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;salt&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">100000</span><span class=\"mtk1\">, </span><span class=\"mtk6\">512</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;sha512&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">console</span><span class=\"mtk1\">.</span><span class=\"mtk7\">log</span><span class=\"mtk1\">(</span><span class=\"mtk11\">`2: Done in ${</span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk11\">}ms`</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;pwd&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;salt&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">100000</span><span class=\"mtk1\">, </span><span class=\"mtk6\">512</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;sha512&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">console</span><span class=\"mtk1\">.</span><span class=\"mtk7\">log</span><span class=\"mtk1\">(</span><span class=\"mtk11\">`3: Done in ${</span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk11\">}ms`</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">pbkdf2</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;pwd&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;salt&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk6\">100000</span><span class=\"mtk1\">, </span><span class=\"mtk6\">512</span><span class=\"mtk1\">, </span><span class=\"mtk11\">&#39;sha512&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">console</span><span class=\"mtk1\">.</span><span class=\"mtk7\">log</span><span class=\"mtk1\">(</span><span class=\"mtk11\">`4: Done in ${</span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk11\">}ms`</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">);</span></span></code></pre>\n<p>แล้ว run ดูอีกครั้งครับจะได้</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.36170212765958%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACIElEQVQ4y31TSW7bMBTVZJGaB2u0KMmObXk26iSLnKQHyKLbbnKDHvz1k1ED2Wi7+PgkQDy9Sdr14xdWIsdxXWK/KnDZ1ViLOd0LPC0yiKqA14eIswBNkuK6H7DNa9yKFV6rDQ7zBsJP4M8shLYNre2WGPoO21ZAZAl2fYtvhz0y34Gra3ANA8zSweVZ0xFYFjzdQGRYSEyb9kzdmaaB02il5xJYi3UjUAQhsWoI8IjIZrDHR8448szGscdhD2+0TrSK4UDMFmmi9uvlhNR11EPJkBv0WDLUdfimqbZHbOXmk48pwOOPD6yaHAfyb9vNcdpUBFpi0yVoUh95HMEuObyAIXM99fE2THGIalxSUhbkKGxPMVWATVWT5A4bIVDHsdqvlwtSh48yPv37w0Cykl765FtgmGrk/YthEwbYLSmYrkcVJwr87faMmHHMJlL4OPZ/PFShtGuqQduoWaQxyZah7FTKnkFMKFU+0+GYn/5FzIZPrEJKWY5M+I7h4f0nltS3oc+ofwnOw4JASzrHDx7a5CE1gkJrg+TfHtZJouTKqUnyumnwcj4j4fyuNnxSm2lNJLu7lJWHfU9htCijWO3b8UStZ3ceOhPPph/gjx4uX95IrqDfTqArqQ5PAs+nHWqSG9kWecbAXROc/pYyDCl9RwE7D/PFcPn9HUXkos09tIWPvgpQhEztBYFmpIDlJJ/puG4HrOoa5lgf5y/AvwE0mjOFVZxHOQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"more hash\"\n        title=\"more hash\"\n        src=\"/static/70d930be9810164569504d3a46260d5a/1d69c/more_hash.png\"\n        srcset=\"/static/70d930be9810164569504d3a46260d5a/4dcb9/more_hash.png 188w,\n/static/70d930be9810164569504d3a46260d5a/5ff7e/more_hash.png 375w,\n/static/70d930be9810164569504d3a46260d5a/1d69c/more_hash.png 750w,\n/static/70d930be9810164569504d3a46260d5a/78797/more_hash.png 1125w,\n/static/70d930be9810164569504d3a46260d5a/e6c84/more_hash.png 1148w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>อ้าววววว ทำไมเหมือนกับว่าเกิดขึ้นพร้อมกันเลยล่ะ? ถ้า node เป็น single-threaded จริง มันต้องทำตามลำดับ 1 --> 2 --> 3 --> 4 ใช้มั้ยครับ ดูจากรูปผม run หลายๆ ครั้งให้ดูเลย เพื่อให้เห็นชัดเจนว่ามันเกิดขึ้น ๆ พร้อมๆ กัน</p>\n<p>สาเหตุที่เป็นแบบนี้ ก็เพราะว่า standard module บางตัว (เช่น crypto) ที่มีการใช้ cpu ประมวลผลสูง node จะไม่ได้ run แค่ single-threaded แต่จะอาศัยตัวช่วยอย่าง <a href=\"http://docs.libuv.org/en/v1.x/threadpool.html\">uv thread pool</a> โดยที่ค่าเริ่มต้นของ <code>uv_thread_pool</code> ก็คือ 4 ถ้าเราอยากให้มัน run แค่ thread เดียว ก็สามารถทำได้แบบนี้ครับ</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"javascript\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// กำหนด UV_THREADPOOL_SIZE แบบนี้</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// ใส่ไว้ข้างบนสุดของ code เมื่อกี้</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">process.env.</span><span class=\"mtk7\">UV_THREADPOOL_SIZE</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">1</span><span class=\"mtk1\">;</span></span></code></pre>\n<p>แล้วทีนี้ลอง run ดูอีกครั้งครับ ผลที่ได้คือ</p>\n<p><img src=\"/path/to/dir/4fc972c7e6d9bf2c9b5336eea433f01a/single_thread.gif\" alt=\"single threaded\"></p>\n<p>ถ้าลองไปอ่านที่ <a href=\"http://docs.libuv.org/en/v1.x/threadpool.html\">doc</a> ของ libuv จะพบว่าเราสามารถกำหนด <code>UV_THREADPOOL_SIZE</code> ได้ถึง 1024 ลองไปเล่นๆ กันดูได้ครับ สรุปคือ node จะใช้ Event Loop บน main thread และจะมี threadpool จาก libuv เอาไว้คอยจัดการพวก cpu intensive task</p>\n<h2>OS Operations</h2>\n<p>ต่อไปก็มาทำความเข้าใจเกี่ยวกับ <code>os operations</code> หรือ <code>pendingOSTasks</code> ที่ผมเขียนไว้ใน psuedo code ตัวอย่างนะครับ ซึ่งเป็นอีกตัวที่น่าสนใจเช่นกัน ลองดู code ตัวอย่างกันครับ</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"javascript\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk3 mtki\">// async.js</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">https</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">require</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;https&#39;</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">const</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk13 mtkb\">function</span><span class=\"mtk1\"> </span><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">() {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk7\">https</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    .</span><span class=\"mtk7\">request</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;https://www.google.com&#39;</span><span class=\"mtk1\">, res </span><span class=\"mtk13 mtkb\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk7\">res</span><span class=\"mtk1\">.</span><span class=\"mtk7\">on</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;data&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span><span class=\"mtk1\"> {});</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk7\">res</span><span class=\"mtk1\">.</span><span class=\"mtk7\">on</span><span class=\"mtk1\">(</span><span class=\"mtk11\">&#39;end&#39;</span><span class=\"mtk1\">, () </span><span class=\"mtk13 mtkb\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk8\">console</span><span class=\"mtk1\">.</span><span class=\"mtk7\">log</span><span class=\"mtk1\">(</span><span class=\"mtk8\">Date</span><span class=\"mtk1\">.</span><span class=\"mtk7\">now</span><span class=\"mtk1\">() </span><span class=\"mtk8\">-</span><span class=\"mtk1\"> </span><span class=\"mtk7\">start</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      });</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    .</span><span class=\"mtk7\">end</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">}</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span></code></pre>\n<p>แล้ว run <code>node async.js</code> จะได้เป็น</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.72340425531915%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABA0lEQVQoz82O306DMBSHy/hXWkobRhlD7BjGMVEnLjHxwhifwPgCvohXvvlPQsAsZlEuduHFl3NyTn/fKXn5+MSmXuOuLrDbGrSNwc2mQHORo702uCpLFOscepvhLNNoqgqP+xb35hLP1Q4PpsZtXiKVETKlQPavT8gXFMq3MecutHARMweK2khCF8rzEHQ7h1lgzgwBId9wYvWVdngDpHx7xzxWWKUc56mAWQgUCccyZlhlAkspIWQAX1NEzAfrJHSQjBweIdKewe0ad7hw2I+MIf+IYGSckzSK+hCzjj/8GQh+kfbCJAx7YUD+FtIpQh3yScKpdEJ2WmEaiX/+w1MLvwDSEPBDHun6nQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"async request\"\n        title=\"async request\"\n        src=\"/static/86f5cea69326b3d90a69403b541aa03b/1d69c/async_request.png\"\n        srcset=\"/static/86f5cea69326b3d90a69403b541aa03b/4dcb9/async_request.png 188w,\n/static/86f5cea69326b3d90a69403b541aa03b/5ff7e/async_request.png 375w,\n/static/86f5cea69326b3d90a69403b541aa03b/1d69c/async_request.png 750w,\n/static/86f5cea69326b3d90a69403b541aa03b/26a94/async_request.png 1102w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>ทีนี้ลองเพิ่มการเรียก function <code>doRequest()</code> ให้เป็นสัก 7 ครั้ง</p>\n<pre class=\"grvsc-container solarized-light\" data-language=\"javascript\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk7\">doRequest</span><span class=\"mtk1\">();</span></span></code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 750px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.91489361702128%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVQoz62R20rDQBCGp0ncdDanTbJtc7KaEpFQWih6571P4K2v4JXv/7vNASRIatGLj5lZhg/+HTp9fOK20tjlIepC4fE+RbUKsCsVHrYpCpUgzAJ4mYeYGU1VdrSqwFFv0UQbZBxAWgv4tg06NIQsIjhEYMPS4A51Dp7UEWprB9rrJXwFU/kIPR8ZRUwQZpCLecFP/fSNDneEtU+wqJc6Q70ZEN+WzynsGWknfHp/Q772kceMTDEq7WEVuN2cJxIpS8jQhQgdJFJi3zSz30P5yyuUL81hXGyiJcrUg/ZF1xdGmHRCATc4CxltXc8LxRBljPjnyGxZv74qX5D1wgsL1/Lvwi9aC+5wbmKgMwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"more async\"\n        title=\"more async\"\n        src=\"/static/9d289272a042c451f4845892768d7318/1d69c/more_async.png\"\n        srcset=\"/static/9d289272a042c451f4845892768d7318/4dcb9/more_async.png 188w,\n/static/9d289272a042c451f4845892768d7318/5ff7e/more_async.png 375w,\n/static/9d289272a042c451f4845892768d7318/1d69c/more_async.png 750w,\n/static/9d289272a042c451f4845892768d7318/99f37/more_async.png 1100w\"\n        sizes=\"(max-width: 750px) 100vw, 750px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>อ้าวววว เรียกไปตั้ง 6 ครั้ง แต่ก็ run พร้อมๆ กันแหะ! ยังไงเนี่ยยยย</p>\n<p>คำตอบก็คือเมื่อมีการทำ network request แบบ code ข้างบน node จะไม่ได้ใช้ <code>UV_THREADPOOL</code> แต่จะไปเรียกใช้ <strong>asynchronous interface</strong> ซึ่งแต่ละระบบปฏิบัติการมีให้อยู่แล้วแทน ถ้าเป็น linux ก็จะเป็น <a href=\"https://man7.org/linux/man-pages/man7/aio.7.html\">AIO</a> เป็นต้น</p>\n<p>หวังว่าจะช่วยคลายข้อสงสัยเกี่ยวกับการทำงานของ Event Loop ไม่มากก็น้อยนะครับ ถ้ามีเวลา ผมจะมาเขียนเกี่ยวกับสิ่งที่น่าสนใจของ Node.js อีกเรื่อยๆ นะครับ</p>\n<p>Happy Coding :)</p>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://www.udemy.com/course/advanced-node-for-developers/\">Node JS: Advanced Concepts</a></li>\n<li><a href=\"http://docs.libuv.org/en/v1.x/threadpool.html\">Thread pool work scheduling</a></li>\n<li><a href=\"https://www.dynatrace.com/news/blog/all-you-need-to-know-to-really-understand-the-node-js-event-loop-and-its-metrics/#disqus_thread\">All you need to know to really understand the Node.js Event Loop and its Metrics</a></li>\n<li><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/\">The Node.js Event Loop, Timers, and <code>process.nextTick()</code></a></li>\n<li><a href=\"https://www.youtube.com/watch?v=PNa9OMajw9w\">Morning Keynote- Everything You Need to Know About Node.js Event Loop - Bert Belder</a></li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n  }\n  \n  .grvsc-code {\n    display: inline-block;\n    min-width: 100%;\n  }\n  \n  .grvsc-line {\n    display: inline-block;\n    box-sizing: border-box;\n    width: 100%;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-line-highlighted {\n    background-color: var(--grvsc-line-highlighted-background-color, transparent);\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, transparent);\n  }\n  \n  .solarized-light { background-color: #FDF6E3; }\n  .solarized-light .mtkb { font-weight: bold; }\n  .solarized-light .mtki { font-style: italic; }\n  .solarized-light .mtk1 { color: #657B83; }\n  .solarized-light .mtk8 { color: #859900; }\n  .solarized-light .mtk3 { color: #93A1A1; }\n  .solarized-light .mtk13 { color: #073642; }\n  .solarized-light .mtk7 { color: #268BD2; }\n  .solarized-light .mtk11 { color: #2AA198; }\n  .solarized-light .mtk6 { color: #D33682; }\n</style>"}},"pageContext":{"slug":"nodejs-event-loop"}},"staticQueryHashes":["3159585216","3364050859","4152315797","440568431"]}